{% extends 'ctm_seller/base/index.html' %}
{% load static %}
{% block title %}
Staff Users | {{site_name}}
{% endblock title %}

{% block content %}
<div class="col-lg-12 m-1">
    <div class="card">
        <div class="card-header">
            <h4>Staff User</h4>
        </div>
        <div class="card-body mt-2">
            <form method="post" enctype="multipart/form-data">
                {% csrf_token %}
                {% for field in form %}
                {% if field.field.widget.input_type == 'checkbox' %}
                <div class="mt-2 form-check form-switch">
                    {{field.label_tag}}
                    <input type="{{field.field.widget.input_type}}" id="id_{{field.name}}" name="{{field.name}}" class="form-check-input">
                    <span><small>{{field.help_text}}</small></span>
                    {% if field.errors %}
                    <div class="alert alert-danger m-0 p-0">{{field.errors}}</div>
                    {% endif %}
                </div>
                {% elif field.field.widget.input_type == 'select' %}
                    {% if field.name == 'seller' %}
                        <div class="mt-3 form-group">
                            {{field.label_tag}}
                            {% if is_by_seller %}
                            <input readonly disabled type="text" id="id_{{field.name}}" name="{{field.name}}" class="form-control" value="{{request.user}}">
                            {% else %}
                                <select id="id_{{field.name}}" name="{{field.name}}" class="form-select">
                                    {% for id,value in field.field.choices %}
                                    <option value="{{id}}" {% if field.value == id %}selected{% endif %}>{{value}}</option>
                                    {% endfor %}
                                </select>
                            {% endif %}
                            {% if field.errors %}
                            <div class="alert alert-danger m-0 p-0">{{field.errors}}</div>
                            {% endif %}
                        </div>
                    {% elif field.name == 'user' %}
                    <div class="my-3">
                        {{field.label_tag}}
                        <!-- <h5 class="mt-2">Basic Details:</h5> -->
                        <div class="form-row">
                            {% if is_by_seller %}
                                <div class="input-group">
                                    <div class="input-group-prepend">
                                        <div class="input-group-text">{{request.user}}@</div>
                                    </div>
                                    <input type="text" class="form-control" id="inputname" name="username" placeholder="Username">
                                    <div class="invalid-feedback invalid-username-feedback" style="display: none"></div>
                                    <p class="text-sm text-success username-success"></p>
                                </div>
                            {% else %}
                            <div class="form-group col-md-12">
                                <input type="text" placeholder="seller@username" id="inputname" name="username" class="form-control">
                                <div class="invalid-feedback invalid-username-feedback" style="display: none"></div>
                                <p class="text-sm text-success username-success"></p>
                            </div>
                            {% endif %}
                        </div>
                        <div style="flex-direction: row;" class="form-row d-flex mt-2">
                                <div class="form-group col-md-6 ">
                                    <input type="text" placeholder="First Name" id="id_first_name" name="first_name" class="form-control">
                                </div>
                                <div class="form-group col-md-6">
                                    <input type="text" placeholder="Last Name" id="id_last_name" name="last_name" class="form-control">
                                </div>
                        </div>
                        <div class="form-row mt-2">
                            <div class="form-group col-md-12">
                                <input type="email" placeholder="Email.." id="inputemail" name="email" class="form-control">
                                <div class="invalid-feedback invalid-email-feedback" style="display: none"></div>
                                <p class="text-sm text-success email-success"></p>
                            </div>
                        </div>
                        <div class="form-row mt-2">
                            <div class="form-group col-md-12">
                                <input type="password" placeholder="Password.." id="id_password" name="password" class="form-control">
                            </div>
                        </div>
                    </div>
                    {% else %}
                        <div class="mt-3 form-group">
                            {{field.label_tag}}
                            <select id="id_{{field.name}}" name="{{field.name}}" class="form-select">
                                {% for id,value in field.field.choices %}
                                <option value="{{id}}" {% if field.value == id %}selected{% endif %}>{{value}}</option>
                                {% endfor %}
                            </select>
                            {% if field.errors %}
                            <div class="alert alert-danger m-0 p-0">{{field.errors}}</div>
                            {% endif %}
                        </div>
                    {% endif %}
                {% else %}
                <div class="mt-3 form-group">
                    {{field.label_tag}}
                    <input type="{{field.field.widget.input_type}}" id="id_{{field.name}}" name="{{field.name}}" class="form-control">
                    <span><small>{{field.help_text}}</small></span>
                    {% if field.errors %}
                    <div class="alert alert-danger m-0 p-0">{{field.errors}}</div>
                    {% endif %}
                </div>
                {% endif %}
                {% endfor %}
                <input type="submit" value="Create" class="btn btn-primary btn-block mt-4 w-100 submit-btn">
            </form>
        </div>
    </div>
</div>
{% endblock content %}


{% block scripts %}
<script src="{% static 'main/js/address.js' %}"></script>
<script>
    const usernameField=document.querySelector('#inputname');
    const emailField=document.querySelector('#inputemail');
    const userfeedback=document.querySelector('.invalid-username-feedback');
    const emailfeedback=document.querySelector('.invalid-email-feedback');
    const usernamesuccess=document.querySelector('.username-success');
    const emailsuccess=document.querySelector('.email-success');
    const submitbtn=document.querySelector('.submit-btn');
    emailField.addEventListener("keyup", (e) => {
        const emailVal = e.target.value;
    
        emailsuccess.textContent=`Checking ${emailVal}`;
    
        emailField.classList.remove("is-invalid");
        emailfeedback.style.display='none';
    
        if (emailVal.length > 0) {
            emailsuccess.style.display='block';
            fetch("/auth/validate-email",{
                body:JSON.stringify({ email : emailVal}),method:"POST",
            }).then(res=>res.json()).then(data=>{
                console.log('data',data);
                emailsuccess.style.display='none';
                if (data.email_error){
                    submitbtn.disabled = true;
                    emailField.classList.add("is-invalid");
                    emailfeedback.style.display='block';
                    emailfeedback.innerHTML=`<p>${data.email_error}</p>`
                }else{
                    submitbtn.removeAttribute('disabled');
                }
            });
        }
    
    });
    usernameField.addEventListener("keyup", (e) => {
        const usernameVal = e.target.value;
    
        usernamesuccess.textContent=`Checking ${usernameVal}`;
    
        usernameField.classList.remove("is-invalid");
        userfeedback.style.display='none';
    
        if (usernameVal.length > 0) {
            usernamesuccess.style.display='block';
            fetch("/auth/validate-username",{
                body:JSON.stringify({ username : usernameVal}),method:"POST",
            }).then(res=>res.json()).then(data=>{
                console.log('data',data);
                usernamesuccess.style.display='none';
                if (data.username_error){
                    submitbtn.disabled = true;
                    usernameField.classList.add("is-invalid");
                    userfeedback.style.display='block';
                    userfeedback.innerHTML=`<p>${data.username_error}</p>`
                }else{
                    submitbtn.removeAttribute('disabled');
                }
            });
        }
    });
</script>
{% endblock scripts %}